<!doctype html>
<html lang="ar">
<head>
  <meta charset="utf-8" />
  <title>لعبة الثعبان — نسخة موبايل وماوس</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --bg:#0f1720;
      --panel:#0b1220;
      --accent:#36d399;
      --danger:#ff6b6b;
      --muted:#94a3b8;
    }
    html,body{height:100%; margin:0; font-family: "Segoe UI", Tahoma, Arial, sans-serif; background:linear-gradient(180deg,#071021 0%, #071827 100%); color:#e6eef8; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;}
    .wrap{min-height:100%; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:12px; padding:18px;}
    .hud{width:100%; max-width:520px; display:flex; justify-content:space-between; align-items:center; gap:8px;}
    .scorebox{background:rgba(255,255,255,0.03); padding:8px 12px; border-radius:10px; display:flex; gap:10px; align-items:center; font-size:16px;}
    .score{font-weight:700; color:var(--accent); min-width:36px; text-align:center;}
    .small{font-size:13px; color:var(--muted);}
    #gameWrap{background:linear-gradient(180deg,#071827, #05111a); padding:12px; border-radius:12px; box-shadow:0 8px 30px rgba(2,6,23,0.6);}
    canvas{display:block; background:#021018; border-radius:8px; touch-action:none; -webkit-user-select:none; user-select:none;}
    .controlsRow{display:flex; gap:8px; margin-top:8px; justify-content:center;}
    .btn{background:#0b1624; border:1px solid rgba(255,255,255,0.04); color:#cfe8ff; padding:8px 12px; border-radius:8px; cursor:pointer;}
    .btn.primary{background:linear-gradient(90deg,var(--accent),#3bb2ff); color:#012; font-weight:700;}
    .msg{color:var(--danger); font-size:14px; min-height:20px; text-align:center; margin-top:6px;}
    /* touch buttons */
    .touchPad{position:relative; width:100%; max-width:520px; height:120px; margin-top:6px; display:flex; justify-content:center; align-items:flex-end; pointer-events:none;}
    .dpad{pointer-events:auto; display:grid; grid-template-columns:repeat(3,56px); grid-template-rows:repeat(3,56px); gap:8px; background:transparent; padding:6px; border-radius:12px;}
    .padBtn{width:56px;height:56px;border-radius:50%; background:rgba(255,255,255,0.03); display:flex; align-items:center; justify-content:center; color:#cfe8ff; font-weight:700; user-select:none; -webkit-user-select:none; cursor:pointer; box-shadow:0 6px 12px rgba(0,0,0,0.5);}
    .padBtn:active{transform:translateY(2px); box-shadow:0 4px 8px rgba(0,0,0,0.5);}
    .padEmpty{background:transparent; box-shadow:none; cursor:default;}
    /* responsive */
    @media (max-width:420px){
      .dpad{grid-template-columns:repeat(3,44px); grid-template-rows:repeat(3,44px); gap:6px;}
      .padBtn{width:44px;height:44px;}
    }
    footer{margin-top:10px; font-size:12px; color:var(--muted);}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="hud">
      <div class="scorebox">
        <div style="text-align:left">
          <div class="small">النتيجة</div>
          <div class="score" id="score">0</div>
        </div>
        <div style="text-align:left">
          <div class="small">الأفضل</div>
          <div class="score" id="high">0</div>
        </div>
      </div>

      <div style="display:flex; gap:8px; align-items:center;">
        <button class="btn" id="pauseBtn">إيقاف</button>
        <button class="btn primary" id="restartBtn">إعادة</button>
      </div>
    </div>

    <div id="gameWrap">
      <canvas id="game" width="480" height="480" style="width:95vw; max-width:480px; height:auto;"></canvas>
      <div class="msg" id="msg"></div>
      <div class="controlsRow small">التحكم: أسهم / WASD / أزرار اللمس / اضغط على الشاشة أو اضغط بالماوس لتغيير الاتجاه</div>
      <!-- touch D-pad -->
      <div class="touchPad" id="touchPad" aria-hidden="true">
        <div class="dpad" id="dpad">
          <div class="padEmpty"></div>
          <div class="padBtn" data-dir="up">↑</div>
          <div class="padEmpty"></div>

          <div class="padBtn" data-dir="left">←</div>
          <div class="padEmpty" style="background:rgba(255,255,255,0.02); border-radius:8px;"></div>
          <div class="padBtn" data-dir="right">→</div>

          <div class="padEmpty"></div>
          <div class="padBtn" data-dir="down">↓</div>
          <div class="padEmpty"></div>
        </div>
      </div>
    </div>

    <footer>نسخة متوافقة مع الجوال والماوس — السهم أو اضغط/اسحب</footer>
  </div>

  <script>
    // عناصر DOM
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');
    const scoreEl = document.getElementById('score');
    const highEl = document.getElementById('high');
    const msgEl = document.getElementById('msg');
    const pauseBtn = document.getElementById('pauseBtn');
    const restartBtn = document.getElementById('restartBtn');
    const dpad = document.getElementById('dpad');
    const touchPad = document.getElementById('touchPad');

    // إعدادات
    const TILE = 16; // حجم الخانة داخل الشبكة (بكسل داخل كانفس)
    const WIDTH = canvas.width;
    const HEIGHT = canvas.height;
    const COLS = Math.floor(WIDTH / TILE);
    const ROWS = Math.floor(HEIGHT / TILE);
    let speed = 90; // ملّي ثانية بين خطوات الحركة (يمكن تغييره)
    let snake = [];
    let dir = {x:1, y:0};
    let nextDir = null;
    let food = null;
    let score = 0;
    let running = false;
    let lastTick = 0;
    let highScore = parseInt(localStorage.getItem('snake_high') || '0',10) || 0;
    highEl.textContent = highScore;
    // رسومات
    function resetGame(){
      snake = [{x: Math.floor(COLS/2), y: Math.floor(ROWS/2)}];
      dir = {x:1, y:0};
      nextDir = null;
      spawnFood();
      score = 0;
      scoreEl.textContent = score;
      msgEl.textContent = '';
      running = true;
      lastTick = performance.now();
    }

    function spawnFood(){
      let ok=false;
      while(!ok){
        const f = {x: Math.floor(Math.random()*COLS), y: Math.floor(Math.random()*ROWS)};
        ok = !snake.some(s=>s.x===f.x && s.y===f.y);
        if(ok) food = f;
      }
    }

    function step(){
      if(!running) return;
      // apply pending direction (to avoid immediate 180)
      if(nextDir){
        if(!(nextDir.x === -dir.x && nextDir.y === -dir.y)) dir = nextDir;
        nextDir = null;
      }
      const head = {x: snake[0].x + dir.x, y: snake[0].y + dir.y};
      // تصادم بالحائط
      if(head.x < 0 || head.x >= COLS || head.y < 0 || head.y >= ROWS){
        endGame();
        return;
      }
      // تصادم بنفسه
      if(snake.some(s=>s.x===head.x && s.y===head.y)){
        endGame();
        return;
      }
      snake.unshift(head);
      // أكل
      if(head.x === food.x && head.y === food.y){
        score++;
        scoreEl.textContent = score;
        spawnFood();
      } else {
        snake.pop();
      }
    }

    function endGame(){
      running = false;
      msgEl.textContent = 'انتهت اللعبة — اضغط إعادة للعب';
      if(score > highScore){
        highScore = score;
        localStorage.setItem('snake_high', String(highScore));
        highEl.textContent = highScore;
        msgEl.textContent = 'انتهت اللعبة — سجلت رقمًا قياسيًا جديدًا! اضغط إعادة للعب';
      }
    }

    // رسم
    function draw(){
      // خلفية
      ctx.clearRect(0,0,WIDTH,HEIGHT);
      // شبكات خفيفة
      ctx.fillStyle = '#031016';
      ctx.fillRect(0,0,WIDTH,HEIGHT);

      // رسم الطعام (دائري مع توهج)
      const fx = food.x * TILE, fy = food.y * TILE;
      const radius = TILE*0.45;
      const g = ctx.createRadialGradient(fx+TILE/2, fy+TILE/2, radius*0.2, fx+TILE/2, fy+TILE/2, radius);
      g.addColorStop(0, '#ff9b5c');
      g.addColorStop(1, '#ff4757');
      ctx.fillStyle = g;
      ctx.beginPath();
      ctx.arc(fx+TILE/2, fy+TILE/2, radius, 0, Math.PI*2);
      ctx.fill();

      // رسم الثعبان (تدرج على الرأس والذيل)
      for(let i=snake.length-1;i>=0;i--){
        const s = snake[i];
        const x = s.x * TILE, y = s.y * TILE;
        if(i===0){
          // رأس
          ctx.fillStyle = '#9be15d';
          ctx.fillRect(x+1,y+1,TILE-2,TILE-2);
          // عين بسيطة
          ctx.fillStyle = '#012';
          const ex = x + TILE/2 + dir.x*4 - 3, ey = y + TILE/2 + dir.y*4 - 3;
          ctx.fillRect(ex, ey, 3, 3);
        } else {
          // جسم
          const t = i/snake.length;
          const col = lerpColor('#2dd4bf','#075985', t);
          ctx.fillStyle = col;
          ctx.fillRect(x+1,y+1,TILE-2,TILE-2);
        }
      }
    }

    // مساعدة تدرج لون
    function lerpColor(a,b,t){
      // a,b hex strings like #rrggbb
      const pa = hexToRgb(a), pb = hexToRgb(b);
      const r = Math.round(pa.r + (pb.r-pa.r)*t);
      const g = Math.round(pa.g + (pb.g-pa.g)*t);
      const bl = Math.round(pa.b + (pb.b-pa.b)*t);
      return `rgb(${r},${g},${bl})`;
    }
    function hexToRgb(hex){
      const m = hex.replace('#','');
      return {r:parseInt(m.substring(0,2),16), g:parseInt(m.substring(2,4),16), b:parseInt(m.substring(4,6),16)};
    }

    // حلقة اللعبة بالزمن
    function loop(ts){
      if(!lastTick) lastTick = ts;
      const diff = ts - lastTick;
      if(diff >= speed){
        step();
        draw();
        lastTick = ts;
      }
      requestAnimationFrame(loop);
    }

    // تحكمات لوحة المفاتيح
    window.addEventListener('keydown', (e)=>{
      if(!running && e.code==='Space'){ resetGame(); return; }
      switch(e.code){
        case 'ArrowUp': case 'KeyW': setDir({x:0,y:-1}); break;
        case 'ArrowDown': case 'KeyS': setDir({x:0,y:1}); break;
        case 'ArrowLeft': case 'KeyA': setDir({x:-1,y:0}); break;
        case 'ArrowRight': case 'KeyD': setDir({x:1,y:0}); break;
      }
    });

    function setDir(d){
      // لا نسمح بدوران 180 مباشرة
      if(d.x === -dir.x && d.y === -dir.y) return;
      nextDir = d;
    }

    // أزرار اللمس
    dpad.addEventListener('click', (ev)=>{
      const btn = ev.target.closest('.padBtn');
      if(!btn) return;
      const dd = btn.dataset.dir;
      if(dd) {
        switch(dd){
          case 'up': setDir({x:0,y:-1}); break;
          case 'down': setDir({x:0,y:1}); break;
          case 'left': setDir({x:-1,y:0}); break;
          case 'right': setDir({x:1,y:0}); break;
        }
      }
    });

    // سحب (swipe) لاكتشاف الاتجاه على الشاشات
    let touchStart = null;
    canvas.addEventListener('touchstart', (e)=>{
      if(e.touches && e.touches[0]) touchStart = {x: e.touches[0].clientX, y: e.touches[0].clientY};
    }, {passive:true});
    canvas.addEventListener('touchend', (e)=>{
      if(!touchStart) return;
      const touch = e.changedTouches[0];
      const dx = touch.clientX - touchStart.x;
      const dy = touch.clientY - touchStart.y;
      const absX = Math.abs(dx), absY = Math.abs(dy);
      const threshold = 20;
      if(Math.max(absX,absY) < threshold){ touchStart = null; return; }
      if(absX > absY){
        setDir({x: dx>0 ? 1 : -1, y:0});
      } else {
        setDir({x:0, y: dy>0 ? 1 : -1});
      }
      touchStart = null;
    });

    // نقرة أو ضغط ماوس على الكانفس لتغيير الاتجاه نسبيًا للرأس
    canvas.addEventListener('pointerdown', (e)=>{
      // حساب موضع النقر داخل الكانفس (تحويل من CSS pixels إلى عناصر كانفس)
      const rect = canvas.getBoundingClientRect();
      const scaleX = canvas.width / rect.width;
      const scaleY = canvas.height / rect.height;
      const cx = (e.clientX - rect.left) * scaleX;
      const cy = (e.clientY - rect.top) * scaleY;
      // مركز رأس الثعبان
      const head = snake[0];
      const hx = head.x * TILE + TILE/2;
      const hy = head.y * TILE + TILE/2;
      const dx = cx - hx, dy = cy - hy;
      if(Math.abs(dx) > Math.abs(dy)){
        setDir({x: dx>0 ? 1 : -1, y:0});
      } else {
        setDir({x:0, y: dy>0 ? 1 : -1});
      }
    });

    // أزرار الواجهة
    pauseBtn.addEventListener('click', ()=>{
      running = !running;
      pauseBtn.textContent = running ? 'إيقاف' : 'استئناف';
      if(running){
        lastTick = performance.now();
      }
    });
    restartBtn.addEventListener('click', ()=>{
      resetGame();
    });

    // منع التمرير أثناء اللعب عند لمس الكانفس
    canvas.addEventListener('touchmove', (e)=>{ if(e.cancelable) e.preventDefault(); }, {passive:false});

    // بدء
    resetGame();
    requestAnimationFrame(loop);

    // تهيئة بسيطة: لوحات المفاتيح الافتراضية تظهر أحياناً على الموبايل؛ إخفاء لوحة لو أصبحت بالتركيز على body:
    // (غير ضروري، مجرد تهيئة)
  </script>
</body>
</html>